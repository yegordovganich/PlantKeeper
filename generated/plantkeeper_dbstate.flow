// Auto-generated by substantiate from sql/plantkeeper.sql
forbid plantkeeper/config;
import promise;

import generated/plantkeeper_tables;
import oauth/generated/oauth_dbstate;
import admin_panel/generated/admin_panel_dbstate;
import drive/generated/drive_dbstate;

export {
	PlantkeeperDbState(
		familiesB : DynamicBehaviour<[Family]>,
		colorsB : DynamicBehaviour<[Color]>,
		leafTypesB : DynamicBehaviour<[LeafType]>,
		carePlansB : DynamicBehaviour<[CarePlan]>,
		plantsB : DynamicBehaviour<[Plant]>
	);

	loadPlantkeeperDbState(jwt : string, onOK : (PlantkeeperDbState) -> void, onError : (string) -> void) -> void;

	makeEmptyPlantkeeperDbState() -> PlantkeeperDbState;

	buildFamilyTable(
		manager : MaterialManager,
		jwt : string, 
		plantkeeperDbState : PlantkeeperDbState, 
		style : [SubTableStyle<Family, ?>]
	) -> Material;
	
	buildColorTable(
		manager : MaterialManager,
		jwt : string, 
		plantkeeperDbState : PlantkeeperDbState, 
		style : [SubTableStyle<Color, ?>]
	) -> Material;
	
	buildLeafTypeTable(
		manager : MaterialManager,
		jwt : string, 
		plantkeeperDbState : PlantkeeperDbState, 
		style : [SubTableStyle<LeafType, ?>]
	) -> Material;
	
	buildCarePlanTable(
		manager : MaterialManager,
		jwt : string, 
		plantkeeperDbState : PlantkeeperDbState, 
		style : [SubTableStyle<CarePlan, ?>]
	) -> Material;
	
	buildPlantTable(
		manager : MaterialManager,
		jwt : string, 
		plantkeeperDbState : PlantkeeperDbState, 
		style : [SubTableStyle<Plant, ?>]
	) -> Material;
}

loadPlantkeeperDbState(jwt : string, onOK : (PlantkeeperDbState) -> void, onError : (string) -> void) -> void {
	familiesPromise = 
		Promise(\fulfill, reject -> { 
			loadFamilys(jwt, fulfill, reject)
		});
	
	colorsPromise = 
		Promise(\fulfill, reject -> { 
			loadColors(jwt, fulfill, reject)
		});
	
	leafTypesPromise = 
		Promise(\fulfill, reject -> { 
			loadLeafTypes(jwt, fulfill, reject)
		});
	
	carePlansPromise = 
		Promise(\fulfill, reject -> { 
			loadCarePlans(jwt, fulfill, reject)
		});
	
	plantsPromise = 
		Promise(\fulfill, reject -> { 
			loadPlants(jwt, fulfill, reject)
		});
	
	promises = [familiesPromise, colorsPromise, leafTypesPromise, carePlansPromise, plantsPromise];

	doneP(parallelP(promises),
		\results : flow -> { // Typing is hard. Forgive us
			PlantkeeperDbState(make(results[0]), make(results[1]), make(results[2]), make(results[3]), make(results[4])) |> onOK
		},
		onError
	)

}

makeEmptyPlantkeeperDbState() -> PlantkeeperDbState {
	PlantkeeperDbState(
		make([]), 
		make([]), 
		make([]), 
		make([]), 
		make([])
	);
}

buildFamilyTable(manager : MaterialManager, jwt : string, plantkeeperDbState : PlantkeeperDbState, style : [SubTableStyle<Family, ?>]) -> Material {
	FamilyTable(
		manager,
		jwt, 
		plantkeeperDbState.familiesB,
		plantkeeperDbState.plantsB,
		style
	);
}

buildColorTable(manager : MaterialManager, jwt : string, plantkeeperDbState : PlantkeeperDbState, style : [SubTableStyle<Color, ?>]) -> Material {
	ColorTable(
		manager,
		jwt, 
		plantkeeperDbState.colorsB,
		plantkeeperDbState.plantsB,
		style
	);
}

buildLeafTypeTable(manager : MaterialManager, jwt : string, plantkeeperDbState : PlantkeeperDbState, style : [SubTableStyle<LeafType, ?>]) -> Material {
	LeafTypeTable(
		manager,
		jwt, 
		plantkeeperDbState.leafTypesB,
		plantkeeperDbState.plantsB,
		style
	);
}

buildCarePlanTable(manager : MaterialManager, jwt : string, plantkeeperDbState : PlantkeeperDbState, style : [SubTableStyle<CarePlan, ?>]) -> Material {
	CarePlanTable(
		manager,
		jwt, 
		plantkeeperDbState.carePlansB,
		plantkeeperDbState.plantsB,
		style
	);
}

buildPlantTable(manager : MaterialManager, jwt : string, plantkeeperDbState : PlantkeeperDbState, style : [SubTableStyle<Plant, ?>]) -> Material {
	PlantTable(
		manager,
		jwt, 
		plantkeeperDbState.plantsB,
		plantkeeperDbState.familiesB,
		plantkeeperDbState.colorsB,
		plantkeeperDbState.leafTypesB,
		plantkeeperDbState.carePlansB,
		style
	);
}

